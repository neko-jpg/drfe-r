# DRFE-R 現状分析レポート

**日時**: 2026-01-03 23:30 JST  
**分析者**: Antigravity AI

---

## 🚨 深刻な問題の発見

TTLを十分に大きく（20,000）設定してテストを実行した結果、**TTL不足ではなく、埋め込み/ルーティングアルゴリズムそのものに深刻な問題**があることが判明しました。

### テスト結果（TTL=20,000、BA topology）

| ノード数 | 成功率 | ストレッチ | Gravity% | 平均ホップ | 最短路 |
|---------|--------|-----------|----------|-----------|--------|
| 100 | 99.2% | **1.93** | 40.3% | 4.9 | 2.5 |
| 500 | 95.8% | **25.2** ❌ | 2.9% | 82.6 | 3.3 |
| 1000 | 92.4% | **59.6** ❌ | 1.2% | 205.2 | 3.4 |
| 2000 | 92.4% | **172.5** ❌ | 0.4% | 641.0 | 3.7 |

---

## 問題の切り分け

### 1. 成功率の頭打ち（92.4%）
- TTLを10倍にしても成功率は改善せず → **TTL不足ではない**
- 約7.6%のパケットが配送不能 → **アルゴリズム的な問題**
- 可能性：
  - Tree fallbackが機能していないケースがある
  - 特定のノード配置でルーティングがスタックする

### 2. ストレッチの壊滅的な悪化
- 目標: **1.5以下**
- 現実: **172倍**（2000ノード時）
- **中間目標の5.0すら達成できていない**

### 3. Gravity比率の崩壊
- 100ノード: 40.3%（許容範囲）
- 2000ノード: **0.4%**（ほぼゼロ）
- **PIE埋め込みが大規模ネットワークで完全に機能していない**

---

## 根本原因の仮説

### 仮説A: PIE埋め込みのスケール限界
PIE（Polar Increasing-angle Embedding）は木構造に対しては理論的に正しいが、
BA/WSのような非木グラフに適用すると：
- 木以外のエッジが座標に反映されない
- 大規模になるほど「木でないエッジ」の割合が増加
- 結果としてGreedy routingが機能しなくなる

### 仮説B: Ricci Flow最適化の効果不足
現在のRicci Flow実装：
- 収束までの反復が不十分
- ステップサイズが不適切
- 大規模グラフで計算量が爆発している可能性

### 仮説C: 座標空間の飽和
Poincaré disk の容量は有限（面積 = π）。
2000ノードを詰め込むと：
- ノード間の区別がつかなくなる
- 境界付近に集中し、精度が低下

---

## 推奨アクション

### 優先度1: 埋め込み改善の実装テスト

```rust
// 試すべきアプローチ
1. PIE + Ricci Flow ハイブリッド
   - PIEで初期化
   - Ricci Flowで微調整（100+ iterations）

2. Ricci Flowパラメータチューニング
   - step_size: 0.01〜0.5の探索
   - iterations: 50, 100, 200, 500

3. 座標圧縮の改善
   - 境界からの距離を確保
   - ノード間の最小距離を保証
```

### 優先度2: 失敗ケースの詳細分析

```
7.6%の失敗パケットについて：
- どのノードペアで失敗するか
- 失敗時のルーティングモード
- ループの有無
```

### 優先度3: Tree Fallbackの検証

```
成功時のTree使用率が98%以上 → 
Gravityが実質機能していない証拠
Tree単体でも7.6%失敗する理由を調査
```

---

## 次のステップの選択肢

### オプションA: Ricci Flow最適化に注力（推奨）
- 週1-2で埋め込み品質を改善
- ストレッチ5.0以下を中間目標に設定
- 効果が見えたら10kスケールに進む

### オプションB: Tree Fallbackの強化
- Tree単体で100%配送可能にする
- ストレッチは諦める（Treeは効率が悪い）
- ロバストネスを先に達成

### オプションC: アルゴリズム再設計
- PIEに依存しない新しい埋め込み手法
- Greedy + Pressure + Treeのバランス再検討
- 大規模ネットワーク向けに根本的に再設計

---

## 結論

現状のDRFE-Rは**1000ノード以上で実用に耐えない**。
ストレッチ172倍は「壊れている」と表現すべき状態。

**最優先タスク**: Ricci Flow最適化の実装・テストを行い、
まず1000ノードでストレッチ5.0以下を達成すること。
